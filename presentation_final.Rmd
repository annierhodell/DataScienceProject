---
title: "Impact Of Covid-19 On A&E Atendances In Scotland"
author: "The A-Team <br> Alice Bullard, Alice Miller, Anna Scollay, Annie O'Dell"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---
```{r install-package, include = FALSE, eval = FALSE}
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
```


```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r data, include=FALSE}
# In this chunk I'm doing a bunch of analysis that I don't want to present 
# in my slides. But I need the resulting data frame for a plot I want to present.
weekly_ae_activity_20231008 <- read_csv("data/weekly_ae_activity_20231008.csv")
HBT_area_names_and_population <- read_csv("data/HBT area names and population.csv")
Treatement_Location_names <- read_csv("data/Treatement Location names.csv")

tidy.data <- weekly_ae_activity_20231008 %>%
  select(-Country, -DepartmentType) %>%
  mutate(WeekEndingDate = ymd(WeekEndingDate)) %>%
  mutate(PercentageOver4HoursEpisode = 
           round((NumberOver4HoursEpisode/NumberOfAttendancesEpisode)*100, digits = 1))

data.HBT.pop <- left_join(tidy.data, HBT_area_names_and_population, by ="HBT")

data.TLnames <- Treatement_Location_names%>%
  rename("TreatmentLocation" = "Postcode of Treatment Location")%>%
  left_join(data.HBT.pop, Treatement_Location_names, by ="TreatmentLocation")

col_order <- c("WeekEndingDate", "HBT", "Area name", "Population", "TreatmentLocation",
               "Name of Treatement Location", "NumberOfAttendancesEpisode", "NumberWithin4HoursEpisode",
               "PercentageWithin4HoursEpisode", "NumberOver4HoursEpisode", "PercentageOver4HoursEpisode", 
               "NumberOver8HoursEpisode", "PercentageOver8HoursEpisode", "NumberOver12HoursEpisode", "PercentageOver12HoursEpisode")

data.order <- data.TLnames[, col_order]

data <- data.order %>%
  rename("Week_Ending_Date" = "WeekEndingDate",
         "Health_Board_Area_Code" = "HBT", 
         "Health_Board_Area_Name" = "Area name", 
         "Area_Population" = "Population", 
         "Treatment_Location_Code" = "TreatmentLocation", 
         "Treatment_Location_Name" = "Name of Treatement Location",
         "Total_Attendees" = "NumberOfAttendancesEpisode", 
         "Attendees_within_4hrs" = "NumberWithin4HoursEpisode", 
         "%_within_4hr" = "PercentageWithin4HoursEpisode", 
         "Attendees_Over_4hrs" = "NumberOver4HoursEpisode",
         "%_Over_4hr" = "PercentageOver4HoursEpisode",
         "Attendees_Over_8hrs" = "NumberOver8HoursEpisode",
         "%_Over_8hr" = "PercentageOver8HoursEpisode", 
         "Attendees_Over_12hrs" = "NumberOver12HoursEpisode",
         "%_Over_12hr" = "PercentageOver12HoursEpisode")
#The Colours of HBT areas for graphs
health_board_area_colours <- c("Greater Glasgow and Clyde" = "red",
                               "Lothian" = "hotpink", "Ayrshire and Arran" = "pink", 
                               "Borders" = "seagreen", "Dumfries and Galloway" = "salmon",
                               "Fife" = "gold", "Forth Valley" = "cyan",
                               "Grampian" = "purple", "Highland" = "royalblue",
                               "Lanarkshire" = "mediumaquamarine", "Orkney" = "darkblue",
                               "Shetland" = "orange","Tayside" = "maroon",
                               "Western Isles" = "powderblue")
```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/confetti.jpg"
)
```

class: center, middle

## The Impact That Covid-19 Has Had On A&E Cases And Waiting Times In Scotland

---

class: centre, middle

### Original A&E Data Table
Columns: WeekEndingDate, Country, HBT, TreatmentLocation, DepartmentType, NumberOfAttendancesEpisode, NumberWithin4HoursEpisode, NumberOver4HoursEpisode, PercentageWithin4HoursEpisode, NumberOver8HoursEpisode, PercentageOver8HoursEpisode, NumberOver12HoursEpisode, PercentageOver12HoursEpisode

```{r ogdata-table, echo = FALSE}
knitr::kable(head(weekly_ae_activity_20231008))
```
---
class: centre, middle

### Tidied A&E Data Table
Columns: Week_Ending_Date, Health_Board_Area_Code, Health_Board_Area_Name, Area_Population, Treatment_Location_Code, Treatment_Location_Name, Total_Attendees, Attendees_within_4hrs, %_within_4hr, Attendees_Over_4hrs, %_Over_4hr, Attendees_Over_8hrs, %_Over_8hr, Attendees_Over_12hrs, %_Over_12hr               

```{r tidydata-table, echo = FALSE}
knitr::kable(head(data))
```
---

class: center, middle

# Impact On Scotland Overall

```{r plot-graph 1, echo= FALSE}
#Line graph of all the cases from 2015-2023

data %>%
  select(Week_Ending_Date, Total_Attendees) %>%
  group_by(Week_Ending_Date) %>%
  summarise(Sum_Total_Attendees= sum(Total_Attendees)) %>%
  ggplot(aes(x = Week_Ending_Date, y = Sum_Total_Attendees)) +
  geom_line()+
  labs(x = "Date",
       y = "Sum of Total Attendees",
       title = "Number of Weekly Attendees",
       subtitle = "2015 - 2023")+
  theme_bw() # theme options: https://ggplot2.tidyverse.org/reference/ggtheme.html
```
---
class: center, middle

# Impact On Scotland Overall by Year
```{r plot-graph 2a, echo= FALSE}
#graph of yearly total attendees to all hospitals
#change date label so it is in months "jan feb march..." instead of days
data_graph_1 <- data %>%
  mutate(Year = year(Week_Ending_Date)) %>%
  mutate(date = yday(Week_Ending_Date))
data_graph_1 %>% 
  group_by(Week_Ending_Date) %>%
  summarise(sumdat=sum(Total_Attendees), Year, date) %>% 
  ggplot(aes(x = date, y = sumdat, colour = as.factor(Year))) +
  geom_line()+
  labs(x = "Day of Year",
       y = "Number of Attendees Across Scotland",
       title = "Number of A&E Attendees across each year",
       colour = "Year")
```
---

class: centre, middle

# Isolating 2020
```{r plot-graph 2b, echo= FALSE}
#graph of yearly total attendees to all hospitals
#change date label so it is in months "jan feb march..." instead of days
data_graph_1 <- data %>%
  mutate(Year = year(Week_Ending_Date)) %>%
  mutate(date = yday(Week_Ending_Date))
data_graph_1 %>% 
  group_by(Week_Ending_Date) %>%
  summarise(sumdat=sum(Total_Attendees), Year, date) %>% 
  ggplot(aes(x = date, y = sumdat, colour = as.factor(Year))) +
  geom_line()+
  labs(x = "Day of Year",
       y = "Number of Attendees Across Scotland",
       title = "Number of A&E Attendees across each year",
       colour = "Year") +
  scale_colour_manual(values = c("2020" = "red"))
```