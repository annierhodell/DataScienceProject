---
title: "Impact Of Covid-19 On A&E's In Scotland"
author: "by the A-Team: Anna Scollay, Alice Bullard, Alice Miller, Annie O'Dell"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%") # for better picture reolution
```


```{r load-lib, include = FALSE}
library(tidyverse)
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(devtools)
```

```{r load-data-2, include=FALSE}
#here we are loading all our data that we have used in our project
weekly_ae_activity_20231008 <- read_csv("data/weekly_ae_activity_20231008.csv") #our original dataset, unedited
HBT_area_names_and_population <- read_csv("data/HBT area names and population.csv")
Treatement_Location_names <- read_csv("data/Treatement Location names.csv")
a_and_e_hb_agesex_20231005 <- read_csv("data/AGE DATA/a_and_e_hb_agesex_20231005.csv")

#tidying our data
tidy.data <- weekly_ae_activity_20231008 %>%
  select(-Country, -DepartmentType) %>%
  mutate(WeekEndingDate = ymd(WeekEndingDate)) %>%
  mutate(PercentageOver4HoursEpisode = 
           round((NumberOver4HoursEpisode/NumberOfAttendancesEpisode)*100, digits = 1))

data.HBT.pop <- left_join(tidy.data, HBT_area_names_and_population, by ="HBT")

data.TLnames <- Treatement_Location_names%>%
  rename("TreatmentLocation" = "Postcode of Treatment Location")%>%
  left_join(data.HBT.pop, Treatement_Location_names, by ="TreatmentLocation")

col_order <- c("WeekEndingDate", "HBT", "Area name", "Population", "TreatmentLocation",
               "Name of Treatement Location", "NumberOfAttendancesEpisode", "NumberWithin4HoursEpisode",
               "PercentageWithin4HoursEpisode", "NumberOver4HoursEpisode", "PercentageOver4HoursEpisode", 
               "NumberOver8HoursEpisode", "PercentageOver8HoursEpisode", "NumberOver12HoursEpisode", "PercentageOver12HoursEpisode")

data.order <- data.TLnames[, col_order]

data <- data.order %>%
  rename("Week_Ending_Date" = "WeekEndingDate",
         "Health_Board_Area_Code" = "HBT", 
         "Health_Board_Area_Name" = "Area name", 
         "Area_Population" = "Population", 
         "Treatment_Location_Code" = "TreatmentLocation", 
         "Treatment_Location_Name" = "Name of Treatement Location",
         "Total_Attendees" = "NumberOfAttendancesEpisode", 
         "Attendees_within_4hrs" = "NumberWithin4HoursEpisode", 
         "%_within_4hr" = "PercentageWithin4HoursEpisode", 
         "Attendees_Over_4hrs" = "NumberOver4HoursEpisode",
         "%_Over_4hr" = "PercentageOver4HoursEpisode",
         "Attendees_Over_8hrs" = "NumberOver8HoursEpisode",
         "%_Over_8hr" = "PercentageOver8HoursEpisode", 
         "Attendees_Over_12hrs" = "NumberOver12HoursEpisode",
         "%_Over_12hr" = "PercentageOver12HoursEpisode")

#tidying data containing age and sex 2020 - 2023
Age_and_Sex_Data <- a_and_e_hb_agesex_20231005 %>%
  mutate(WeekEnding = ymd(WeekEnding))%>%
  rename("HBT" = HB)

Age_and_Sex_Data <- 
  left_join(Age_and_Sex_Data, HBT_area_names_and_population, by ="HBT")

col_order_NEWDATA <- c("WeekEnding", "HBT", "Area name", "Population", "AgeGroup",
                       "Sex", "NumberAttendances", "Average20182019")

Age_and_Sex_Data <- Age_and_Sex_Data[, col_order_NEWDATA]

#The Colours of HBT areas for graphs
health_board_area_colours <- c("Greater Glasgow and Clyde" = "red",
                               "Lothian" = "hotpink", "Ayrshire and Arran" = "pink", 
                               "Borders" = "seagreen", "Dumfries and Galloway" = "salmon",
                               "Fife" = "gold", "Forth Valley" = "cyan",
                               "Grampian" = "purple", "Highland" = "royalblue",
                               "Lanarkshire" = "mediumaquamarine", "Orkney" = "darkblue",
                               "Shetland" = "orange","Tayside" = "maroon",
                               "Western Isles" = "powderblue")
view(data)
```
http://libraryguides.vu.edu.au/c.php?g=386501&p=4347840 #reference info accessed 20/oct/2023

# Introduction

In this project, we are aiming to investigate what impact area population has on the number of A&E cases in their areas. We also want to look at Covid-19s impact on case numbers to see how they differed to pre-Covid times.

We will be using the following data throughout this project:

- weekly_ae_activity_20231008: This data set looks at the weekly attendances of accident and emergency centers in Scotland from 2015 to 2023. The data set includes the total amount of weekly attendees at each center along with sectioning them into time taken to process the patient, either within 4 hours, over 4, over 8 or over 12 hours, along with columns for their associated percentages (ommiting percentage over 4 hours). This data contains the treatment location codes for each hospital and the health board area codes (HBT codes) for each area.

- a_and_e_hb_agesex_20231005: This data set includes weekly attendances of accident and emergency centers whilst also looking at the age and sex of patients. The data runs from 5 January 2020 to 21 May 2023.

- HBT area names and population: We made this data set to contain the area names and populations corresponding to the given HBT codes in the original data set so we could join them together. I.e. S08000015 is the HBT code for the area Ayrshire and Arran. 

- Treatment Location names: We made this data set to contain the treatment location names corresponding to the given treatment location codes in the original data set so we could join them together. I.e. A111H is the treatment location code for University Hospital Crosshouse.

To look at the impact of covid-19, we recall that covid-19 predominately occurred in 2020. It involved a long period of stay at home isolation for the public throughout the year and kept hospitals working at their capacity. We think this will impact the way hospitals dealt with cases at their A&E department. 

# Method
## Methods – Summarise what cleaning/pre-processing you have done to your data. Brief description of data science techniques you have used in your investigation.

The steps we took to tidy our main data set, weekly_ae_activity_20231008, now called data, are as follows:

- Removed unnecessary columns unused in our project using select().

- formatted the week ending date into proper date format using mutate(WeekEndingDate = ymd(WeekEndingDate)).

- added in a column for the percentage of cases processed in over 4 hours as this column was missing from the data set. 

- joined with HBT area names and population using left_join().

- joined with Treatment Location names using left_join().

- reordered the columns using a vector.

- renamed the columns to make it clear what they contained.

We used similar steps to tidy a_and_e_hb_agesex_20231005, now called Age and Sex Data. 

# Results
## Results – Tables, figures and summary values from your exploratory investigation. Summary of a fitted statistical model, such as estimates, plots and fit statistic. A brief explanation of what the results mean in the given context of your data.

# Discussion
## Discussion – Answers your research question(s). What are the advantages/limitations of the investigation you have performed? If applicable, are there any ethical considerations in relation to your investigation/findings?




The HBT(Health Board Areas) our data covers are shown below: 
```{r Map Of Scotland- plot, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE, out.width="75%", fig.align='center'}
worldmap <- read_csv("Data/Data Files/worldmap.csv")

#map of Scotland with HBT areas
worldmap %>%
  ggplot() + 
  geom_polygon(data = worldmap, 
               aes(x = long, y = lat, 
                   group = group), 
               fill = 'lightblue', 
               color = 'black') + 
  coord_fixed(ratio = 1.4, 
              xlim = c(-9,1), 
              ylim = c(54.8, 61))+
  theme_bw()+
  labs(title = "Map of Scotland's HBT Areas",
            stat = "unique",
            size = 5,
            color = "blue")+
  geom_text(aes(x = -0.2, y = 60.5,
                label = "Shetland"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -2, y = 59,
                label = "Orkney"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -4.7, y = 57,
                label = "Highland"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -8, y = 58,
                label = "Western Isles"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3, y = 57.4,
                label = "Grampian"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3.4, y = 56.2,
                label = "Fife"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3.6, y = 56.8,
                label = "Tayside"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -4.2, y = 56.5,
                label = "Forth Valley"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3, y = 55.8,
                label = "Lothian"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -2.3, y = 55.4,
                label = "Borders"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -4.1, y = 55.9,
                label = "GGC"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3.7, y = 55.5,
                label = "Lanarkshire"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3, y = 55.2,
                label = "Dumfries"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -3, y = 55.1,
                label = "& Galloway"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -4.3, y = 55.3,
                label = "Ayrshire"),
            stat = "unique",
            size = 3, color = "black")+
  geom_text(aes(x = -4.3, y = 55.2,
                label = "& Arran"),
            stat = "unique",
            size = 3, color = "black")
```

## Findings

Initially, we wanted to view the total attendees per week from 2015 to 2023:

```{r plot-graph 1, echo=FALSE}
data %>%
  select(Week_Ending_Date, Total_Attendees) %>%
  group_by(Week_Ending_Date) %>%
  summarise(Sum_Total_Attendees= sum(Total_Attendees)) %>%
  ggplot(aes(x = Week_Ending_Date, y = Sum_Total_Attendees)) +
  geom_line()+
  labs(x = "Date",
       y = "Sum of Total Attendees",
       title = "Number of A&E Attendees per Week",
       subtitle = "2015 - 2023") +
  theme_bw()
```

The above graph shows a drastic decrease in A&E attendances around March 2020, when the Covid-19 impact was greatest. In order to compare each year against 2020, we need to separate them:

```{r plot-graph-2, echo=FALSE, message=FALSE, warning=FALSE}
data_graph_1 <- data %>%
  mutate(Year = year(Week_Ending_Date)) %>%
  mutate(date = yday(Week_Ending_Date))

data_graph_1 %>% 
  group_by(Week_Ending_Date) %>%
  summarise(sumdat=sum(Total_Attendees), Year, date) %>% 
  ggplot(aes(x = date, y = sumdat, colour = as.factor(Year))) +
  geom_line()+
  labs(x = "Day of Year",
       y = "Number of Attendees Across Scotland",
       title = "Number of A&E Attendees across each year",
       colour = "Year")
```

The write-up of your project and findings go here. 

Think of this as the text of your presentation with some extra detail to cover what there was not time to discuss in the presentation. This might include any assumptions you made when doing your analysis, any limitations of the work you have done or any ideas you have for future work. Feel free to split this section into subsections to make it easier to read. 

The length should be roughly 1,500 words. 
If you want to use a word count addin, you can install this by copying and pasting the following into RStudio:

devtools::install_github("benmarwick/wordcountaddin", type = "source", dependencies = TRUE)

You will then need to restart RStudio. Once you have done that, select the text you want to count the words of, go to Addins, and select the `Word count` addin.
This addin counts words using two different algorithms, but the results should be similar and as long as you're in the ballpark of 1,500 words, you're good! 
The addin will ignore code chunks and only count the words in prose. If you don't want to use the addin you can always copy and paste the text into Microsoft Word to do a Word Count!

You can also load your data here and present any analysis results / plots.
Make sure to hide your code with  `echo = FALSE` unless the point you are trying to make is about the code itself, in which case you should show your code.





## References

PHS Unscheduled Care Team 2023, *Weekly A&E Activity and Waiting Times*, data file

List any references here. You should, at a minimum, list your data source.


